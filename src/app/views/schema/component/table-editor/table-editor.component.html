<div class="table-editor">
  <div class="tabs-container">
    <mat-tab-group [(selectedIndex)]="selectedTabIndex">
      <mat-tab label="Tabelas ({{tables.length}})">
        <div class="tab-content">
          <!-- <div class="search-bar">
            <input type="text" placeholder="Buscar..." class="search-input">
            <button class="search-button">
              <i class="bi bi-search"></i>
            </button>
          </div> -->
          
          <div class="action-button">
            <button mat-button class="add-table-btn" (click)="addTable()">
              <i class="bi bi-plus"></i> Adicionar tabela
            </button>
          </div>
          
          <div class="tables-list" cdkScrollable>
            @for (table of tables; track table.id; let i = $index) {
              <div class="table-item">
                <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      {{table.name}}
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  
                  <div class="table-details">
                    <div class="input-group">
                      <label>Nome:</label>
                      <input type="text" [(ngModel)]="table.name" (change)="updateTable(table)">
                    </div>
                    
                    <div class="columns-container" 
                         cdkDropList 
                         [cdkDropListData]="table.columns"
                         [cdkDropListConnectedTo]="getDropListIds()"
                         [id]="'columns-' + table.id"
                         (cdkDropListDropped)="onColumnDrop($event, table)">
                      
                      @if (table.columns.length === 0) {
                        <div class="empty-columns-placeholder">
                          <i class="bi bi-database"></i>
                          <span>Arraste colunas aqui ou adicione uma nova</span>
                        </div>
                      }
                      
                      @for (column of table.columns; track column.name; let j = $index) {
                        <div class="column-row" 
                             cdkDrag 
                             [cdkDragData]="getDragData(column)"
                             [cdkDragDisabled]="!canDropColumn(column, table)">
                          
                          <!-- Drag Handle -->
                          <div class="drag-handle" cdkDragHandle matTooltip="Arrastar coluna">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M6 2C6 1.44772 6.44772 1 7 1C7.55228 1 8 1.44772 8 2C8 2.55228 7.55228 3 7 3C6.44772 3 6 2.55228 6 2Z" fill="#6C757D"/>
                              <path d="M6 8C6 7.44772 6.44772 7 7 7C7.55228 7 8 7.44772 8 8C8 8.55228 7.55228 9 7 9C6.44772 9 6 8.55228 6 8Z" fill="#6C757D"/>
                              <path d="M6 14C6 13.4477 6.44772 13 7 13C7.55228 13 8 13.4477 8 14C8 14.5523 7.55228 15 7 15C6.44772 15 6 14.5523 6 14Z" fill="#6C757D"/>
                              <path d="M10 2C10 1.44772 10.4477 1 11 1C11.5523 1 12 1.44772 12 2C12 2.55228 11.5523 3 11 3C10.4477 3 10 2.55228 10 2Z" fill="#6C757D"/>
                              <path d="M10 8C10 7.44772 10.4477 7 11 7C11.5523 7 12 7.44772 12 8C12 8.55228 11.5523 9 11 9C10.4477 9 10 8.55228 10 8Z" fill="#6C757D"/>
                              <path d="M10 14C10 13.4477 10.4477 13 11 13C11.5523 13 12 13.4477 12 14C12 14.5523 11.5523 15 11 15C10.4477 15 10 14.5523 10 14Z" fill="#6C757D"/>
                            </svg>
                          </div>

                          <div class="column-name">
                            <input type="text" [(ngModel)]="column.name" (change)="updateTable(table)">
                          </div>
                          <div class="column-type">
                            <select [(ngModel)]="column.type" (change)="onTypeChange(table, column)">
                              <option value="">Type</option>
                              @for (type of dataTypes; track type) {
                                <option [value]="type">{{type}}</option>
                              }
                            </select>
                          </div>
                          <div class="column-length" *ngIf="column.type === 'VARCHAR' || column.type === 'CHAR'">
                            <input type="number" 
                                   [(ngModel)]="column.length" 
                                   (change)="onLengthChange(table, column)"
                                   placeholder="Length"
                                   min="1"
                                   max="65535">
                          </div>
                          <div class="column-actions">
                            <button mat-icon-button matTooltip="Não Nulo" class="notnull-btn" 
                                    [class.notnull-btn-active]="column.isNotNull" 
                                    [disabled]="column.isPrimaryKey"
                                    (click)="toggleNotNull(table, j)">
                              <i class="bi bi-exclamation-circle"></i>
                            </button>
                            <button mat-icon-button matTooltip="Chave" class="key-btn" 
                                    [class.active]="column.isPrimaryKey" 
                                    (click)="togglePrimaryKey(table, j)">
                              <i class="bi bi-key"></i>
                            </button>
                            <button mat-icon-button matTooltip="Unique" class="unique-btn" 
                                    [class.unique-btn-active]="column.isUnique" 
                                    [disabled]="column.isPrimaryKey"
                                    (click)="toggleUnique(table, j)">
                              <i class="bi bi-lock"></i>
                            </button>
                            <button mat-icon-button matTooltip="Remover coluna" (click)="removeColumn(table, j)">
                              <i class="bi bi-x-lg"></i>
                            </button>
                          </div>
                        </div>
                      }
                    </div>

                    <div class="table-actions">
                      <button mat-button class="add-column-btn" (click)="addColumn(table)">
                        Adicionar campo
                      </button>
                      <button mat-icon-button class="remove-table-btn" matTooltip="Remover tabela" (click)="removeTable(table.id, i)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>

                    

                  </div>
                </mat-expansion-panel>
              </div>
            }
          </div>
        </div>
      </mat-tab>
      
      <!-- <mat-tab label="Índices ({{totalIndexesCount}})">
        <div class="tab-content">
          <div class="indexes-tab-content" cdkScrollable>
            @if (tables.length > 0) {
              @for (table of tables; track table.id) {
                <div class="table-indexes-section">
                  <div class="table-header">
                    <h3>{{table.name}}</h3>
                    <span class="indexes-count">({{table.indices?.length || 0}} índices)</span>
                  </div>
                  
                  <div class="indexes-content">
                    @if ((table.indices?.length || 0) > 0) {
                      @for (index of table.indices; track index.id) {
                        <div class="index-row">
                          <div class="index-fields">
                            <div class="index-name">
                              <label>Nome do índice:</label>
                              <input type="text" 
                                     [(ngModel)]="index.name" 
                                     (change)="updateIndex(table, index)"
                                     placeholder="Nome do índice">
                            </div>
                            
                            <div class="index-columns">
                              <label>Colunas incluídas:</label>
                              <div class="columns-checkboxes">
                                @for (column of table.columns; track column.name) {
                                  <label class="checkbox-label">
                                    <input type="checkbox" 
                                           [checked]="index.columns.includes(column.name)"
                                           (change)="handleIndexColumnChange($event, table, index, column.name)">
                                    {{column.name}}
                                  </label>
                                }
                              </div>
                            </div>
                            
                            <div class="index-type">
                              <label>Tipo de índice:</label>
                              <select [(ngModel)]="index.type" (change)="updateIndex(table, index)">
                                @for (type of indexTypes; track type) {
                                  <option [value]="type">{{type}}</option>
                                }
                              </select>
                            </div>
                            
                            <div class="index-unique">
                              <label class="checkbox-label">
                                <input type="checkbox" 
                                       [(ngModel)]="index.isUnique" 
                                       (change)="updateIndex(table, index)">
                                Único?
                              </label>
                            </div>
                          </div>
                          
                          <div class="index-actions">
                            <button mat-icon-button 
                                    matTooltip="Remover índice" 
                                    (click)="removeIndex(table, index.id)">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </div>
                      }
                    } @else {
                      <div class="no-indexes">
                        <p>Nenhum índice definido para esta tabela</p>
                      </div>
                    }
                    
                    <div class="add-index-container">
                      <button mat-button class="add-index-btn" (click)="addIndex(table)">
                        <i class="bi bi-plus"></i> Adicionar índice
                      </button>
                    </div>
                  </div>
                </div>
              }
            } @else {
              <div class="no-tables">
                <p>Nenhuma tabela criada. Vá para a aba "Tabelas" para criar uma tabela primeiro.</p>
              </div>
            }
          </div>
        </div>
      </mat-tab> -->
    </mat-tab-group>
  </div>
</div>
